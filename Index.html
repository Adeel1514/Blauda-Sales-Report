<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agent Dashboard by Shift - Dark Blue Theme</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 40px;
    background: #001f3f; /* Dark blue */
    color: white;
    user-select: none;
  }
  h2 {
    color: #00aaff;
    margin-bottom: 10px;
    text-align: center;
  }
  input, select, button {
    margin: 5px 8px 10px 0;
    padding: 6px 12px;
    border-radius: 5px;
    border: 1px solid #00aaff;
    background: #003366;
    color: white;
    font-weight: 600;
    font-size: 14px;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    cursor: pointer;
  }
  input:hover, select:hover, button:hover {
    background-color: #005f9e;
    border-color: #00c0ff;
  }
  #monthFilters button {
    background-color: #003366;
    border: 1px solid #00aaff;
    color: white;
    font-weight: 700;
    transition: all 0.3s ease;
    margin-right: 6px;
    margin-bottom: 6px;
  }
  #monthFilters button.active, #monthFilters button:hover {
    background-color: #00aaff;
    color: #001f3f;
    box-shadow: 0 0 8px 2px #00aaffaa;
  }
  .shift-container {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 30px;
  }
  .shift-table {
    width: 48%;
    background: #003366;
    box-shadow: 0 4px 10px #004080cc;
    border-radius: 8px;
    padding: 15px 20px 25px 20px;
    transition: box-shadow 0.3s ease;
  }
  .shift-table:hover {
    box-shadow: 0 6px 20px #00aaffcc;
  }
  .shift-table h3 {
    margin-top: 0;
    color: #00c0ff;
    text-align: center;
    font-size: 1.3em;
    letter-spacing: 1.2px;
    margin-bottom: 12px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 13.8px;
    border-radius: 5px;
    overflow: hidden;
    background: #00264d;
  }
  thead th {
    background: linear-gradient(45deg, #0066cc, #0099ff);
    color: white;
    padding: 11px 10px;
    font-weight: 700;
    letter-spacing: 0.8px;
    cursor: pointer;
    user-select: none;
    border-right: 1px solid #005f9e;
    transition: background-color 0.3s ease;
  }
  thead th:hover {
    background: #00aaff;
    box-shadow: inset 0 -3px 10px #33ccff;
  }
  tbody tr:nth-child(odd) {
    background-color: #004080;
  }
  tbody tr:hover {
    background-color: #0073e6;
  }
  tbody td {
    padding: 8px 12px;
    border-right: 1px solid #0073e6;
    color: white;
  }
  tbody td:last-child, thead th:last-child {
    border-right: none;
  }
  #topAgentsHeader {
    text-align: center;
    margin-top: 40px;
    margin-bottom: 15px;
    font-size: 1.4em;
    font-weight: 700;
    color: #00d0ff;
    text-shadow: 0 0 6px #00bfffaa;
  }
  #topAgents {
    display: flex;
    justify-content: center;
    gap: 20px;
    max-width: 920px;
    margin: 0 auto 50px auto;
  }
  .top-agent-box {
    background: #004080;
    border: 2px solid #00c0ff;
    border-radius: 12px;
    padding: 20px 25px;
    flex: 1;
    box-shadow: 0 0 15px 4px #00c0ff88;
    color: #a0e7ff;
    font-weight: 700;
    font-size: 1.2em;
    text-align: center;
    user-select: none;
    animation: fadeBlink 3s infinite alternate ease-in-out;
    transition: transform 0.3s ease;
  }
  .top-agent-box:hover {
    transform: scale(1.05);
    box-shadow: 0 0 25px 8px #00ffffbb;
    color: #d0ffff;
  }
  .top-agent-name {
    font-size: 1.4em;
    margin-bottom: 8px;
    color: #00e5ff;
    text-shadow: 0 0 4px #00cfffaa;
  }
  .top-agent-metric {
    font-size: 1.2em;
    color: #66e0ff;
  }
  @keyframes fadeBlink {
    0% {
      box-shadow: 0 0 15px 4px #00c0ff88;
      background-color: #003366;
    }
    50% {
      box-shadow: 0 0 35px 7px #00e0ffcc;
      background-color: #005080;
    }
    100% {
      box-shadow: 0 0 15px 4px #00c0ff88;
      background-color: #003366;
    }
  }
</style>
</head>
<body>
  <h2>Agent Dashboard by Shift (Offline)</h2>

  <input type="file" id="csvFileInput" accept=".csv" />

  <div id="monthFilters"></div>

  <label for="topBy" style="font-weight:700;">Top 3 Based On:</label>
  <select id="topBy">
    <option value="sokTotal">SOK Count</option>
    <option value="profitTotal">Estimated Profit</option>
    <option value="callsTotal">Total Calls</option>
  </select>

  <div id="topAgentsHeader">Top 3 Agents</div>
  <div id="topAgents"></div>

  <div class="shift-container">
    <div class="shift-table">
      <h3>Morning Shift</h3>
      <div id="morningTable"></div>
    </div>

    <div class="shift-table">
      <h3>Night Shift</h3>
      <div id="nightTable"></div>
    </div>
  </div>

<script>
  const csvFileInput = document.getElementById('csvFileInput');
  const monthFilters = document.getElementById('monthFilters');
  const topAgentsDiv = document.getElementById('topAgents');
  const topBySelect = document.getElementById('topBy');
  const morningDiv = document.getElementById('morningTable');
  const nightDiv = document.getElementById('nightTable');

  let allData = [];
  let headers = [];
  let currentMonth = "ALL";
  let currentSort = {
    morning: { key: null, direction: 1 },
    night: { key: null, direction: 1 }
  };

  csvFileInput.addEventListener('change', function (e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function (event) {
      const text = event.target.result;
      const lines = text.trim().split('\n').map(line => parseCSVLine(line));
      headers = lines[0];
      allData = lines.slice(1);
      generateMonthFilters();
      displayData("ALL");
    };

    reader.readAsText(file);
  });

  // Basic CSV parser for quoted CSV cells with commas inside
  function parseCSVLine(line) {
    const result = [];
    let inQuotes = false, value = '';
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"' && line[i+1] === '"') {
        value += '"';
        i++;
      } else if (c === '"') {
        inQuotes = !inQuotes;
      } else if (c === ',' && !inQuotes) {
        result.push(value.trim());
        value = '';
      } else {
        value += c;
      }
    }
    result.push(value.trim());
    return result;
  }

  function generateMonthFilters() {
    const monthIndex = headers.indexOf("Month");
    const months = new Set(allData.map(row => row[monthIndex]));
    let html = `<button onclick="displayData('ALL')" id="filter_ALL" class="active">Select All</button>`;
    months.forEach(month => {
      html += `<button onclick="displayData('${month}')" id="filter_${month}">${month}</button>`;
    });
    monthFilters.innerHTML = html;
  }

  topBySelect.addEventListener("change", () => {
    displayData(currentMonth);
  });

  function displayData(selectedMonth) {
    currentMonth = selectedMonth;

    document.querySelectorAll("#monthFilters button").forEach(btn => btn.classList.remove("active"));
    const selectedButton = document.getElementById(`filter_${selectedMonth}`);
    if (selectedButton) selectedButton.classList.add("active");

    const indices = {
      month: headers.indexOf("Month"),
      agent: headers.indexOf("Sales Agent"),
      shift: headers.indexOf("Shift"),
      sok: headers.indexOf("SOK Count"),
      reserved: headers.indexOf("Reserved Count"),
      calls: headers.indexOf("Total Calls"),
      talk: headers.indexOf("Total Talktime"),
      profit: headers.indexOf("Estimated SOK Profit")
    };

    const filteredData = selectedMonth === "ALL"
      ? allData
      : allData.filter(row => row[indices.month] === selectedMonth);

    const grouped = { morning: {}, night: {} };
    const allAgentsForTop = {};

    filteredData.forEach(row => {
      const agent = row[indices.agent];
      const shiftStr = row[indices.shift].toLowerCase();
      const shift = shiftStr.includes("morning") ? "morning" : "night";
      const sok = parseFloat(row[indices.sok]) || 0;
      const reserved = parseFloat(row[indices.reserved]) || 0;
      const calls = parseFloat(row[indices.calls]) || 0;

      let talk = 0;
      const talkRaw = row[indices.talk];
      if (/^\d+(\.\d+)?$/.test(talkRaw)) {
        talk = parseFloat(talkRaw);
      } else {
        const parts = talkRaw.split(':').map(x => parseInt(x, 10));
        if (parts.length === 3) {
          talk = parts[0]*3600 + parts[1]*60 + parts[2];
        } else if (parts.length === 2) {
          talk = parts[0]*60 + parts[1];
        }
      }

      const profit = parseFloat(row[indices.profit]) || 0;

      if (!grouped[shift][agent]) {
        grouped[shift][agent] = {
          agent, sokTotal: 0, reservedTotal: 0,
          callsTotal: 0, talkTotal: 0, profitTotal: 0
        };
      }

      grouped[shift][agent].sokTotal += sok;
      grouped[shift][agent].reservedTotal += reserved;
      grouped[shift][agent].callsTotal += calls;
      grouped[shift][agent].talkTotal += talk;
      grouped[shift][agent].profitTotal += profit;

      // Collect for top agents (both shifts combined)
      if (!allAgentsForTop[agent]) {
        allAgentsForTop[agent] = {
          sokTotal: 0, callsTotal: 0, profitTotal: 0
        };
      }
      allAgentsForTop[agent].sokTotal += sok;
      allAgentsForTop[agent].callsTotal += calls;
      allAgentsForTop[agent].profitTotal += profit;
    });

    // Convert grouped objects to arrays for table display
    const morningAgents = Object.values(grouped.morning);
    const nightAgents = Object.values(grouped.night);

    // Sort by current sort column or default by callsTotal descending
    function sortData(arr, shiftKey) {
      const key = currentSort[shiftKey].key || "callsTotal";
      const dir = currentSort[shiftKey].direction;
      arr.sort((a,b) => (a[key] - b[key]) * dir);
    }
    sortData(morningAgents, "morning");
    sortData(nightAgents, "night");

    renderTable(morningDiv, morningAgents, "morning");
    renderTable(nightDiv, nightAgents, "night");

    renderTopAgents(allAgentsForTop);
  }

  function renderTable(container, data, shiftKey) {
    if (data.length === 0) {
      container.innerHTML = "<p style='text-align:center;color:#88bbff;'>No data available for this shift.</p>";
      return;
    }

    const columns = [
      { key: 'agent', label: 'Agent' },
      { key: 'sokTotal', label: 'SOK' },
      { key: 'reservedTotal', label: 'Reserved' },
      { key: 'callsTotal', label: 'Calls' },
      { key: 'talkTotal', label: 'Talktime' },
      { key: 'profitTotal', label: 'Profit' }
    ];

    let html = "<table><thead><tr>";
    columns.forEach(col => {
      html += `<th data-key="${col.key}" data-shift="${shiftKey}">${col.label}</th>`;
    });
    html += "</tr></thead><tbody>";

    data.forEach(row => {
      html += "<tr>";
      html += `<td>${row.agent}</td>`;
      html += `<td>${row.sokTotal.toFixed(0)}</td>`;
      html += `<td>${row.reservedTotal.toFixed(0)}</td>`;
      html += `<td>${row.callsTotal.toFixed(0)}</td>`;
      html += `<td>${formatSeconds(row.talkTotal)}</td>`;
      html += `<td>$${row.profitTotal.toFixed(2)}</td>`;
      html += "</tr>";
    });
    html += "</tbody></table>";

    container.innerHTML = html;

    // Add click sorting to headers
    container.querySelectorAll('thead th').forEach(th => {
      th.style.userSelect = "none";
      th.style.cursor = "pointer";
      th.onclick = () => {
        const key = th.getAttribute("data-key");
        const shift = th.getAttribute("data-shift");
        if (currentSort[shift].key === key) {
          currentSort[shift].direction *= -1;
        } else {
          currentSort[shift].key = key;
          currentSort[shift].direction = 1;
        }
        displayData(currentMonth);
      };
    });
  }

  function renderTopAgents(allAgents) {
    const topBy = topBySelect.value;
    const arr = Object.entries(allAgents).map(([agent, metrics]) => ({
      agent,
      value: metrics[topBy] || 0
    }));
    arr.sort((a,b) => b.value - a.value);
    const top3 = arr.slice(0,3);

    if (top3.length === 0) {
      topAgentsDiv.innerHTML = "<p style='text-align:center;color:#88bbff;'>No agent data for this month.</p>";
      return;
    }

    topAgentsDiv.innerHTML = `
      <div class="top-agent-box" title="Top 1">
        <div class="top-agent-name">${top3[0].agent}</div>
        <div class="top-agent-metric">${formatTopValue(topBy, top3[0].value)}</div>
      </div>
      <div class="top-agent-box" title="Top 2">
        <div class="top-agent-name">${top3[1] ? top3[1].agent : "-"}</div>
        <div class="top-agent-metric">${top3[1] ? formatTopValue(topBy, top3[1].value) : ""}</div>
      </div>
      <div class="top-agent-box" title="Top 3">
        <div class="top-agent-name">${top3[2] ? top3[2].agent : "-"}</div>
        <div class="top-agent-metric">${top3[2] ? formatTopValue(topBy, top3[2].value) : ""}</div>
      </div>
    `;
  }

  function formatSeconds(totalSeconds) {
    if (isNaN(totalSeconds) || totalSeconds <= 0) return "00:00";
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = Math.floor(totalSeconds % 60);
    if (h > 0) {
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }
    return `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  }

  function formatTopValue(key, val) {
    if (key === "profitTotal") {
      return "$" + val.toFixed(2);
    } else if (key === "talkTotal") {
      return formatSeconds(val);
    } else {
      return val.toFixed(0);
    }
  }

  // Expose displayData to window so buttons can call it
  window.displayData = displayData;
</script>
</body>
</html>
